---
title: "Surface Roughness"
author: "Jared Stabach, Smithsonian Conservation Biology Institute"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: true
    number_sections: false
    #theme: united
    #highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<a href="https://github.com/Smithsonian/Addax_DistributionModel.git" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

## Calculate Surface Roughness

We assumed that addax would select inter-dunal depressions. Instead of including the raw SRTM (elevation) data in our models, we created a variable from the raw elevation termed *Surface Roughness*. This variable is the change in elevation range between neighboring pixels. That is, it is the difference between the minimum and maximum values of a cell and its eight surrounding neighbors. Pixels with similar neighborhood values have a low change in elevation range (e.g., flat areas), whereas highly variables neighborhoods have a large change in elevation range (e.g., steep slopes) (Wilson, Oâ€™Connell, Brown, Guinan, & Grehan, 2007).

Original data were downloaded from [EarthExplorer](http://earthexplorer.usgs.gov/). Additional information on SRTM can be found [here](https://www2.jpl.nasa.gov/srtm/). I selected a study area window and the data product in the [EarthExplorer](http://earthexplorer.usgs.gov/) application. The data were then bulk downloaded using the USGS [bda](https://earthexplorer.usgs.gov/bulk/) tool. 

30-m data often have no data areas (i.e., "holes"). These are errors that must be further processed. To fill these areas, I downloaded an ancillary dataset (the 90-m SRTM gap-filled product (also available on the [EarthExplorer](http://earthexplorer.usgs.gov/) site). In ArcGIS, I used a conditional statement to fill the no data areas with the 90-meter data (con(IsNull(srtm_30m),srtm_90m,srtm_30m). Data were projected to UTM Zone 32 North, WGS84 datum (30-meter spatial resolution).

Reference:

Wilson, M.F.J., O'Connell, B., Brown, C., Guinan, J.C., Grehan, A.J., 2007. Multiscale terrain analysis of multibeam bathymetry data for habitat mapping on the continental slope. Marine Geodesy 30: 3-35.

### Loading Libraries

```{r Lib, eval=T, warning=F, message=F}
# Remove everything in memory
rm(list=ls())

# Load raster and rgdal library
library(raster)
library(sp)
library(rgdal)
library(proj4)
```

### Loading Data

Here we load a subset of the full SRTM dataset for our study region.  This is simply because the dataset has 30-m resolution and can take a long time to process.

```{r Load, eval=T}
# Load the 30-m SRTM dataset, located in the Data directory
srtm <- raster("Data/srtm_30m")
```

Now load the spatial points dataset (plot locations):
```{r Spatial Data, eval=T}

# Load the point data
Sub <- readOGR(dsn="Data", layer="Clipped_Add")

# Look at the file
head(Sub)
```

**Questions:** 

1) Are these files projected?  How would you check?
2) What is the [R](https://cran.r-project.org/) function for re-projecting raster and/or spatial point data files if you needed to?
3) What should you always do when importing spatial data (also good practice for any data you load into [R](https://cran.r-project.org/))?

```{r Questions, eval=F, echo=F}
# Answers to questions:
# 1) Print the name of the file to the R console.  This will provide information on the attributes of the file.  If projected, these details will appear in the output.  Use compareCRS() to determine if the projections match
srtm
Sub
compareCRS(srtm,Sub)
# 2) For raster and vector files, the function differs
help(st_transform)
help(projectRaster)
# 3) Plot your data.  R does not have projection on the fly capabilities, so if you data do not overlay, there is a problem.  See below for plotting of data.
```

Plot the results

```{r PlotSRTM, eval=T}
# Plot the result
plot(srtm)
plot(Sub,pch=15,cex=0.7,add=TRUE)
```

### Generate Terrain Variables

Terrain variables can be applied to elevation datasets (digital elevation models).  This includes calculating the slope, aspect, Terrain Position Index (TPI), Terrain Ruggedness Index (TRI), and surface roughness.  Use `help(terrain)` for additional information.

```{r Roughness, eval = T}
rough <- terrain(srtm,opt='roughness')
plot(rough)
```

### Extract Values 

The `extract` command is extremely useful for joining point values from underlying datasets.  These values can easily be appended to your existing dataframe and used in analyses.

```{r Extract, eval=T}
# Extract SRTM mean values within a 2.5 km buffer of each point location.  
Sub$ROUGH <- extract(rough,Sub,method='simple',buffer=2500,fun=mean)

# How is this different than just extracting at the point?
# See `help(extract)` for details about function syntax.  
Sub$RGH_PT <- extract(rough,Sub)

# Look at the data
head(Sub)
```
